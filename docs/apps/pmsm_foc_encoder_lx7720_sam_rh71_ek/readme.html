<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB | Harmony 3 Motor Control Application Examples for SAM RH71 family</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 Motor Control Applications for SAM RH71 family" /> <meta property="og:description" content="Harmony 3 Motor Control Applications for SAM RH71 family" /> <link rel="canonical" href="../../apps/pmsm_foc_encoder_lx7720_sam_rh71_ek/readme.html" /> <meta property="og:url" content="../../apps/pmsm_foc_encoder_lx7720_sam_rh71_ek/readme.html" /> <meta property="og:site_name" content="Harmony 3 Motor Control Application Examples for SAM RH71 family" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB" /> <script type="application/ld+json"> {"@type":"WebPage","url":"../../apps/pmsm_foc_encoder_lx7720_sam_rh71_ek/readme.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"headline":"Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB","description":"Harmony 3 Motor Control Applications for SAM RH71 family","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../index.html" class="nav-list-link">Microchip MPLAB® Harmony 3 Motor Control Application Examples for SAM RH71 family</a><ul class="nav-list "><li class="nav-list-item active"><a href="../../apps/pmsm_foc_encoder_lx7720_sam_rh71_ek/readme.html" class="nav-list-link active">Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../apps/docs/hardware_setup.html" class="nav-list-link">Hardware Setup</a><ul class="nav-list "><li class="nav-list-item "><a href="../../apps/docs/sam_rh71_ek_board_lx7720_db.html" class="nav-list-link">Setup for quadrature encoder mode</a></li></ul></li><li class="nav-list-item"><a href="../../release_notes.html" class="nav-list-link">Release notes</a></li><li class="nav-list-item"><a href="../../mplab_harmony_license.html" class="nav-list-link">License</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Harmony 3 Motor Control Application Examples for SAM RH71 family" aria-label="Search Harmony 3 Motor Control Application Examples for SAM RH71 family" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../index.html">Microchip MPLAB® Harmony 3 Motor Control Application Examples for SAM RH71 family</a></li> <li class="breadcrumb-nav-list-item"><span>Encoder based PMSM FOC using SAM RH71 EK and LX7720 DB</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><a href="https://www.microchip.com"><img src="https://www.microchip.com/ResourcePackages/Microchip/assets/dist/images/logo.png" alt="MCHP" /></a></p> <h1 id="pmsm-foc-using-quadrature-encoder-with-samrh71-ek-and-lx7720-boards"> <a href="#pmsm-foc-using-quadrature-encoder-with-samrh71-ek-and-lx7720-boards" aria-labelledby="pmsm-foc-using-quadrature-encoder-with-samrh71-ek-and-lx7720-boards" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PMSM FOC using Quadrature Encoder with SAMRH71-EK and LX7720 boards </h1> <p>This example shows how to perform motor control using the SAMRH71-EK board connected to the LX7720 board. The control strategy is the sensored FOC, in which rotor position is determined by the Quadrature Encoder and speed is calculated from the position.</p> <h2 id="description"> <a href="#description" aria-labelledby="description" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Description </h2> <p>Permanent Magnet Synchronous Motor (PMSM) is controlled using Field Oriented Control (FOC). Rotor position and speed is determined from quadrature encoder in LX7720. Motor start/stop operation is controlled by the switch and motor speed can be changed by the on-board potentiometer. Waveforms and variables can be monitored at runtime using X2CScope.</p> <p>Key features enabled in this project are:</p> <ul> <li>Dual shunt current measurement</li> <li>Speed control loop</li> </ul> <h2 id="mplab-harmony-configurations"> <a href="#mplab-harmony-configurations" aria-labelledby="mplab-harmony-configurations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> MPLAB Harmony Configurations </h2> <p><img src="../../apps/pmsm_foc_encoder_lx7720_sam_rh71_ek/images/pmsm_foc_encoder_sam_rh71_project_graph.jpg" alt="MHC Project Graph" /></p> <ul> <li>PWM Peripheral: <ul> <li>This peripheral is used to generated three phases synchronous PWM waveforms. Fault functionality is also enabled to switch off the output waveforms asynchronously</li> </ul> </li> <li>TC Peripherals: <ul> <li>TC0 <ul> <li>Channel 0 to trigger periodic PWM duty updates.</li> <li>Channel 1 to trigger periodic interrupt for current sampling in TC3.</li> </ul> </li> <li>TC1 <ul> <li>This peripheral is used in quadrature encoder mode for position measurement</li> </ul> </li> <li>TC3 <ul> <li>Used for sampling the sigma delta modulators signals from LX7720 board.</li> </ul> </li> </ul> </li> <li>FLEXCOM Peripheral: <ul> <li>The UART is used for X2CScope communication to observe graphs and variable values in run time.</li> </ul> </li> </ul> <h2 id="algorithm-and-current-measurement"> <a href="#algorithm-and-current-measurement" aria-labelledby="algorithm-and-current-measurement" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Algorithm and current measurement </h2> <p>The control algorithm is the same as in the PMSM using an Encoder based Field Oriented Control (FOC) in the SAME70 microcontroller example</p> <p>An additional algorithm is used to get the currents on phase A and B from the LX7720. A decimation filter is used to convert the sigma delta modulators output from LX7720.</p> <h3 id="current-conversion-with-decimation-filter"> <a href="#current-conversion-with-decimation-filter" aria-labelledby="current-conversion-with-decimation-filter" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Current conversion with decimation filter </h3> <p>The second order sigma delta modulator output of the LX7720 is a noise shaped signal where le low frequency noise is pushed toward the high frequencies.</p> <p>The SAMRH71 provide a 25MHz clock to the LX7720 modulator which in turn generates modulated signals that can be sampled by the SAMRH71.</p> <p>The sampling is done with one timer counter per motor phase (A and B). The timer counters use two channels clocked at 50MHz. For each channel we use the “Burst signal” selection to have respectively XC0 (TCLK3) or (TCLK4) XC1 ANDed with the counting clock. The channel 0 of the same timer is used as reference to trigger a periodic interrupt for sampling, here every 4µs. This first sampling act as first SINC1 filter with OSR1=50.</p> <p>A digital third order CIC filter (also known as SINC3) is used to do anti-aliasing filtering and decimate to the desired data-rate​. This filter is applied on every SINC1 samples (OSR2=5). With this configuration we get SINC3 samples every 20µs which corresponds to 2.5 samples per PWM periods.</p> <p>The final calculation for phases A and B currents is performed in the FOC control interrupt routine. The currents are calculated with a weighted average on the last 4 samples.</p> <p>The FOC control loop is executed in an interrupt routine generate by a timer counter. This counter starts when the PWM event signal is raised. Then the interrupt is triggered after 20µs using the timer compare mode. This ensures that we have at least one current SINC3 sample calculated before the weight average calculation.</p> <p><img src="images/pwm_current_sample_diagram.jpg" alt="PWM and Current samples diagram" title="PWM and Current samples diagram" /></p> <h2 id="development-kits"> <a href="#development-kits" aria-labelledby="development-kits" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Development Kits </h2> <h3 id="sam-rh71-evaluation-kit-and-lx7720-daughter-board"> <a href="#sam-rh71-evaluation-kit-and-lx7720-daughter-board" aria-labelledby="sam-rh71-evaluation-kit-and-lx7720-daughter-board" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SAM RH71 Evaluation Kit and LX7720 Daughter Board </h3> <h4 id="downloading-and-building-the-application"> <a href="#downloading-and-building-the-application" aria-labelledby="downloading-and-building-the-application" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Downloading and building the application </h4> <p>To clone or download this application from Github, go to the <a href="https://github.com/Microchip-MPLAB-Harmony/mc_apps_sam_rh71">main page of this repository</a> and then click <strong>Clone</strong> button to clone this repository or download as zip file. This content can also be downloaded using content manager by following these <a href="https://github.com/Microchip-MPLAB-Harmony/contentmanager/wiki">instructions</a>.</p> <p>Path of the application within the repository is <strong>apps/pmsm_foc_encoder_lx7720_sam_rh71_ek</strong> .</p> <p>To build the application, refer to the following table and open the project using its IDE.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Project Name</th> <th>Description</th> <th>Demo User Guide</th> </tr> </thead> <tbody> <tr> <td>sam_rh71_ek.X</td> <td>MPLABX project for SAM RH71 Evaluation Kit and LX7720 Daughter Board</td> <td><a href="../../apps/docs/sam_rh71_ek_board_lx7720_db.html">Hardware Setup and Running The Application on SAM RH71 Evaluation Kit with LX7720 Daughter Board</a></td> </tr> <tr> <td> </td> <td> </td> <td> </td> </tr> </tbody> </table></div> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2021 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
